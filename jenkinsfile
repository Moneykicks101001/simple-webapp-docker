pipeline {
    agent any

    stages {

        stage('Append Route') {
            steps {
                script {
                    // Execute the shell script to append the route
                    sh 'chmod +x append.sh'
                    sh './append.sh'
                }
            }
        }

        stage('Show app.py file') {
            steps {
                script {
                    // Execute the shell script to append the route
                    sh 'cat app.py'
                }
            }
        }
        stage('Copy Code to Remote Server') {
            steps {
                script {
                    // Define the SSH credentials ID and remote server details
                    def sshCredentialsId = '552af145-0824-4fe3-8e8f-4d7f12f4863d'
                    def remoteServer = 'root@python'
                    def remotePath = '/home'

                    // Use SSH agent to copy the code to the remote server
                    sshagent(credentials: [sshCredentialsId]) {
                        sh "scp -r ./app.py $remoteServer:$remotePath"
                    }
                }
            }
        }
        stage('Stop application') {
            steps {
                script {
                    // Define the SSH credentials ID and remote server details
                    def sshCredentialsId = '552af145-0824-4fe3-8e8f-4d7f12f4863d'
                    def remoteServer = 'root@python'
                    def remotePath = '/home'

                    sshagent(credentials: [sshCredentialsId]) {
                        sh """
                        ssh $remoteServer 'ss -lptn "sport = :5000" | awk -F'[(,=]' '/python/{system("kill " \$5)}''
                        """
                    }
                }
            }
        }
        stage('Run Python Script on Remote Server') {
            steps {
                script {
                    // Define the SSH credentials ID and remote server details
                    def sshCredentialsId = '552af145-0824-4fe3-8e8f-4d7f12f4863d'
                    def remoteServer = 'root@python'
                    def remotePath = '/home'

                    // Use SSH agent to run the Python script on the remote server
                    sshagent(credentials: [sshCredentialsId]) {
                        sh "ssh -f $remoteServer 'cd $remotePath && nohup python app.py > /dev/null 2>&1 &'"
                    }
                }
            }
        }
    }

}
